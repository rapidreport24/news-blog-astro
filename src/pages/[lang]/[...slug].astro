---
import fs from 'fs';
import path from 'path';
import BlogLayout from "../../layouts/BlogLayout.astro";

// Normalize route params
const lang = Astro.params.lang || 'en'; // fallback if missing
const type = Astro.params.type || 'news'; // fallback if missing

// slug can be string or array
const slugArray = Array.isArray(Astro.params.slug)
  ? Astro.params.slug
  : (Astro.params.slug ? [Astro.params.slug] : ['index']); // fallback 'index'

// Build content path safely
const contentDir = path.join(process.cwd(), 'src', 'content', type, lang);
const filePath = path.join(contentDir, ...slugArray.filter(Boolean));

// Read markdown safely
let frontmatter = {};
let content = '';

if (fs.existsSync(filePath)) {
  const fileContent = fs.readFileSync(filePath, 'utf-8');
  const frontmatterMatch = fileContent.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
  if (frontmatterMatch) {
    const frontmatterText = frontmatterMatch[1];
    content = frontmatterMatch[2];
    frontmatterText.split('\n').forEach(line => {
      const [key, ...valueParts] = line.split(':');
      if (key && valueParts.length > 0) {
        frontmatter[key.trim()] = valueParts.join(':').trim().replace(/^["']|["']$/g, '');
      }
    });
  }
} else {
  // fallback if file missing
  console.warn(`Markdown file not found: ${filePath}`);
}
---
<BlogLayout
  title={frontmatter.title || "Untitled"}
  description={frontmatter.description || ""}
  publishedAt={frontmatter.publishedAt || ""}
  imageUrl={frontmatter.imageUrl || ""}
  language={lang}
>
  <article set:html={content} />
</BlogLayout>
